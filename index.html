<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    /* ...existing code... */
    /* Blokuj double-tap zoom na przyciskach i inputach na iOS/Safari */
    button, input, label {
      touch-action: manipulation;
    }
    /* Blokuj pinch-zoom na całej stronie */
    html, body {
      touch-action: pan-x pan-y;
    }
  </style>
  <script>
    // Blokuj double-tap zoom na przyciskach na iOS/Safari
    document.addEventListener('DOMContentLoaded', function() {
      const preventZoom = e => {
        if (e.touches && e.touches.length > 1) {
          e.preventDefault();
        }
      };
      document.body.addEventListener('touchstart', preventZoom, { passive: false });
      document.body.addEventListener('touchmove', preventZoom, { passive: false });
      // Blokuj double-tap zoom na kliknięciach
      let lastTouch = 0;
      document.body.addEventListener('touchend', function(e) {
        const now = Date.now();
        if (now - lastTouch <= 350) {
          e.preventDefault();
        }
        lastTouch = now;
      }, { passive: false });
    });
  </script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    #randomCountryBtn, #scoreBox, #countryInput, #submitBtn, #messageBox {
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    /* Kontenery boczne */
    .side-panel {
      position: absolute;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #111;
      border-radius: 12px;
      padding: 8px 0;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    }
    .side-panel.left { top: 16px; left: 16px; }
    .side-panel.right-top { top: 30px; right: 16px; z-index: 1002; }
    .side-panel.right-mid { top: 124px; right: 16px; z-index: 1002; }
    /* Responsywność */
    @media (max-width: 600px) {
      .side-panel, .side-panel.left, .side-panel.right-top, .side-panel.right-mid {
        position: absolute;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: #111;
        border-radius: 12px;
        padding: 8px 0;
        box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      }
      .side-panel.left { top: 16px; left: 16px; }
      .side-panel.right-top { top: 30px; right: 16px; z-index: 1002; }
      .side-panel.right-mid { top: 124px; right: 16px; z-index: 1002; }
      #globeViz {
        width: 100vw !important;
        height: 90vw !important;
        min-height: 340px;
        max-height: 70vh;
      }
      #scoreBox, #messageBox {
        font-size: 1.1em;
        width: 100%;
      }
      label {
        font-size: 1em;
      }
      .mobile-answer-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        background: #181818ee;
        display: flex;
        gap: 8px;
        padding: 10px 4vw 10px 4vw;
        box-shadow: 0 -2px 12px rgba(0,0,0,0.18);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        align-items: center;
        transition: transform 0.2s;
        will-change: transform;
      }
      .mobile-answer-bar input {
        flex: 1 1 0;
        font-size: 17px !important;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #bbb;
        outline: none;
        min-width: 0;
      }
      .mobile-answer-bar button {
        font-size: 17px !important;
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        background: #16a34a;
        color: #fff;
        cursor: pointer;
        flex-shrink: 0;
      }
    }
    /* Dla bardzo małych ekranów */
    @media (max-width: 400px) {
      #globeViz {
        min-height: 180px;
      }
    }
  </style>

  <script src="//cdn.jsdelivr.net/npm/globe.gl"></script>
  <!--<script src="../../dist/globe.gl.js"></script>-->
</head>

<body>

  <div class="side-panel left">
    <button id="randomCountryBtn" style="padding:10px 18px;font-size:1em;border-radius:8px;border:none;background:#3b82f6;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.10);">Show random country</button>
    <div id="scoreBox" style="background:#fff;padding:6px 14px;border-radius:8px;font-size:1em;color:#222;box-shadow:0 2px 8px rgba(0,0,0,0.07);">Score: 0</div>
    <input id="countryInput" type="text" placeholder="Enter country name" style="padding:8px 12px;font-size:17px;border-radius:8px;border:1px solid #bbb;outline:none;" autocomplete="off" inputmode="text" />
    <button id="submitBtn" style="padding:8px 12px;font-size:1em;border-radius:8px;border:none;background:#16a34a;color:#fff;cursor:pointer;">Check</button>
    <div id="messageBox" style="min-height:24px;color:#b91c1c;font-weight:bold;"></div>
  </div>
  <!-- Pasek odpowiedzi na dole dla mobile -->
  <form class="mobile-answer-bar" id="mobileAnswerBar" style="display:none;">
    <input id="mobileCountryInput" type="text" placeholder="Enter country name" autocomplete="off" inputmode="text" />
    <button id="mobileSubmitBtn" type="submit">Check</button>
  </form>
  <script>
    // Pokazuj pasek odpowiedzi na dole tylko na mobile
    function isMobile() {
      return window.matchMedia && window.matchMedia('(max-width: 600px)').matches;
    }
    function syncMobileInput() {
      // Synchronizuj inputy desktop/mobile
      if (!isMobile()) return;
      const mainInput = document.getElementById('countryInput');
      const mobileInput = document.getElementById('mobileCountryInput');
      mobileInput.value = mainInput.value;
    }
    function showMobileBarIfNeeded() {
      const bar = document.getElementById('mobileAnswerBar');
      if (isMobile()) {
        bar.style.display = 'flex';
      } else {
        bar.style.display = 'none';
      }
    }
    window.addEventListener('resize', showMobileBarIfNeeded);
    window.addEventListener('orientationchange', showMobileBarIfNeeded);
    document.addEventListener('DOMContentLoaded', function() {
      showMobileBarIfNeeded();
      syncMobileInput();
    });
    // Synchronizuj inputy
    document.getElementById('countryInput').addEventListener('input', function(e) {
      if (isMobile()) document.getElementById('mobileCountryInput').value = e.target.value;
    });
    document.getElementById('mobileCountryInput').addEventListener('input', function(e) {
      if (isMobile()) document.getElementById('countryInput').value = e.target.value;
    });
    // Obsługa submit na mobile
    document.getElementById('mobileAnswerBar').addEventListener('submit', function(e) {
      e.preventDefault();
      document.getElementById('countryInput').value = document.getElementById('mobileCountryInput').value;
      document.getElementById('submitBtn').click();
    });
    // Po losowaniu kraju focus na input (mobile)
    function focusMobileInputIfNeeded() {
      if (isMobile()) {
        setTimeout(() => {
          document.getElementById('mobileCountryInput').focus();
        }, 200);
      }
    }
    // Patchuj drawRandomCountry by focusować input na mobile
    const origDrawRandomCountry = drawRandomCountry;
    drawRandomCountry = function() {
      origDrawRandomCountry();
      focusMobileInputIfNeeded();
    }

    // Detekcja klawiatury i podnoszenie paska odpowiedzi
    let lastWindowHeight = window.innerHeight;
    let keyboardVisible = false;
    function adjustMobileBarForKeyboard() {
      const bar = document.getElementById('mobileAnswerBar');
      if (!isMobile()) return;
      // Jeśli wysokość okna spadła o >150px, uznajemy że pojawiła się klawiatura
      const heightDiff = lastWindowHeight - window.innerHeight;
      if (heightDiff > 150) {
        bar.style.transform = `translateY(-${heightDiff}px)`;
        keyboardVisible = true;
      } else {
        bar.style.transform = '';
        keyboardVisible = false;
      }
    }
    window.addEventListener('resize', function() {
      adjustMobileBarForKeyboard();
      lastWindowHeight = window.innerHeight;
    });
    document.getElementById('mobileCountryInput').addEventListener('focus', function() {
      setTimeout(adjustMobileBarForKeyboard, 100);
    });
    document.getElementById('mobileCountryInput').addEventListener('blur', function() {
      setTimeout(() => {
        document.getElementById('mobileAnswerBar').style.transform = '';
      }, 200);
    });
  </script>
  <div class="side-panel right-top">
    <button id="popChoroplethBtn" style="padding:10px 18px;font-size:1em;border-radius:8px;border:none;background:#3b82f6;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.10);">Show Population by Country</button>
    <label style="color:#fff;font-size:0.95em;"><input type="checkbox" id="popAltCheckbox" style="margin-right:6px;">Set altitude by population</label>
  </div>
  <div class="side-panel right-mid">
    <button id="gdpChoroplethBtn" style="padding:10px 18px;font-size:1em;border-radius:8px;border:none;background:#f59e42;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.10);">Show GDP by Country</button>
    <label style="color:#fff;font-size:0.95em;"><input type="checkbox" id="gdpAltCheckbox" style="margin-right:6px;">Set altitude by GDP</label>
  </div>
  <div id="globeViz"></div>

  <script>
    let correctCountries = new Set();
    let wrongCountries = new Set();

    const world = new Globe(document.getElementById('globeViz'))
      .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-dark.jpg')
      .polygonCapColor(feat => {
        if (window.__highlightedCountry && window.__highlightedCountry === feat) return 'rgba(255, 255, 255, 0.85)'; // strong white glow for current
        if (correctCountries.has(feat.properties.ISO_A3)) return 'rgba(80, 255, 80, 0.7)'; // strong green glow for correct
        if (wrongCountries.has(feat.properties.ISO_A3)) return 'rgba(255,0,0,0.7)'; // strong red glow for wrong
        return 'rgba(255,255,255,.2)'; // default
      })
      .polygonSideColor(() => 'rgba(255, 255, 255, 0.35)') //vertykalny kolor kraju
      .polygonStrokeColor(() => 'rgba(255, 255, 255, 0.35)')
      .polygonLabel(({ properties: d }) => `
          <b>${d.ADMIN} (${d.ISO_A2})</b> <br />
          Population: <i>${Math.round(+d.POP_EST / 1e4) / 1e2}M</i>
        `);



    let countriesList = [];
    window.__highlightedCountry = null;
    let score = 0;
    let currentCountry = null;


    function updateScore() {
      document.getElementById('scoreBox').innerText = 'Score: ' + score;
    }

    function showMessage(msg, color = '#b91c1c') {
      const box = document.getElementById('messageBox');
      box.innerText = msg;
      box.style.color = color;
    }

    function drawRandomCountry() {
      if (!countriesList.length) return;
      const random = countriesList[Math.floor(Math.random() * countriesList.length)];
      window.__highlightedCountry = random;
      currentCountry = random;
      world.polygonAltitude(feat => {
        if (window.__highlightedCountry && window.__highlightedCountry === feat) return 0.1; // higher for glow
        if (correctCountries.has(feat.properties.ISO_A3)) return 0.005; // higher for glow
        return 0.004;
      });
      // Wyznacz centroid kraju (średnia wszystkich punktów)
      let coords = random.geometry.coordinates;
      let points = [];
      function flatten(arr) {
        return arr.reduce((acc, val) => Array.isArray(val[0]) ? acc.concat(flatten(val)) : acc.concat([val]), []);
      }
      if (random.geometry.type === 'Polygon') {
        points = flatten(coords);
      } else if (random.geometry.type === 'MultiPolygon') {
        points = flatten(coords);
      }
      let lat = 0, lng = 0;
      if (points.length) {
        for (const pt of points) {
          lng += pt[0];
          lat += pt[1];
        }
        lng /= points.length;
        lat /= points.length;
      } else {
        lat = 0; lng = 0;
      }
      world.pointOfView({ lat, lng, altitude: 1.8 }, 1200);
      document.getElementById('countryInput').value = '';
      showMessage('');
      document.getElementById('countryInput').focus();
    }
    fetch('ne_110m_admin_0_countries.geojson').then(res => res.json()).then(countries => {
      countriesList = countries.features;
      world.polygonsData(countriesList);
      // Usuwamy obsługę hovera dla altitude
      drawRandomCountry();
    });

    // Obsługa przycisku losowego kraju
    document.getElementById('randomCountryBtn').onclick = function() {
      drawRandomCountry();
    };

    // Obsługa sprawdzania odpowiedzi
    document.getElementById('submitBtn').onclick = function() {
      if (!currentCountry) return;
      const input = document.getElementById('countryInput').value.trim().toLowerCase();
      // Sprawdź różne możliwe nazwy
      const names = [
        currentCountry.properties.ADMIN,
        currentCountry.properties.NAME,
        currentCountry.properties.NAME_LONG,
        currentCountry.properties.BRK_NAME,
        currentCountry.properties.FORMAL_EN,
        currentCountry.properties.FORMAL_FR,
        currentCountry.properties.ISO_A2,
        currentCountry.properties.ISO_A3
      ].filter(Boolean).map(n => String(n).trim().toLowerCase());
      if (names.includes(input)) {
        score++;
        updateScore();
        correctCountries.add(currentCountry.properties.ISO_A3);
        showMessage('Correct!', '#16a34a');
        setTimeout(drawRandomCountry, 1000);
      } else {
        wrongCountries.add(currentCountry.properties.ISO_A3);
        showMessage('Incorrect country name!');
        setTimeout(drawRandomCountry, 1200);
      }
    };

    // Enter w polu input = submit
    document.getElementById('countryInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('submitBtn').click();
      }
    });

    let popChoroplethActive = false;
    document.getElementById('popChoroplethBtn').onclick = function() {
      popChoroplethActive = !popChoroplethActive;
      const popAlt = document.getElementById('popAltCheckbox').checked;
      if (popChoroplethActive) {
        // Find min/max population for scaling
        const pops = countriesList.map(f => f.properties.POP_EST).filter(Boolean);
        const minPop = Math.min(...pops);
        const maxPop = Math.max(...pops);
        world.polygonCapColor(feat => {
          if (window.__highlightedCountry && window.__highlightedCountry === feat) return 'rgba(255, 255, 255, 0.85)';
          if (correctCountries.has(feat.properties.ISO_A3)) return 'rgba(80, 255, 80, 0.7)';
          if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 'rgba(255,0,0,0.7)';
          const pop = feat.properties.POP_EST;
          if (!pop || isNaN(pop)) return popAlt ? 'rgba(255,255,255,1)' : 'rgba(255,255,255,0.05)';
          // Logarithmic scaling
          const norm = (Math.log(pop) - Math.log(minPop)) / (Math.log(maxPop) - Math.log(minPop));
          const r = Math.round(255 * (1 - norm));
          const g = Math.round(255 * (1 - norm));
          const b = Math.round(255 * (1 - norm) + 120 * norm);
          const alpha = popAlt ? 1 : (0.15 + 0.55 * norm);
          return `rgba(${r},${g},${b},${alpha.toFixed(2)})`;
        });
        if (popAlt) {
          world.polygonAltitude(feat => {
            if (window.__highlightedCountry && window.__highlightedCountry === feat) return 0.1;
            if (correctCountries.has(feat.properties.ISO_A3)) return 0.005;
            if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 0.005;
            const pop = feat.properties.POP_EST;
            if (!pop || isNaN(pop)) return 0.004;
            // Linear scaling
            const norm = (pop - minPop) / (maxPop - minPop);
            return 0.01 + 0.09 * norm;
          });
        }
        this.textContent = 'Hide Population by Country';
      } else {
        // Restore default coloring
        world.polygonCapColor(feat => {
          if (window.__highlightedCountry && window.__highlightedCountry === feat) return 'rgba(255, 255, 255, 0.85)';
          if (correctCountries.has(feat.properties.ISO_A3)) return 'rgba(80, 255, 80, 0.7)';
          if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 'rgba(255,0,0,0.7)';
          return 'rgba(255,255,255,.2)';
        });
        world.polygonAltitude(feat => {
          if (window.__highlightedCountry && window.__highlightedCountry === feat) return 0.1;
          if (correctCountries.has(feat.properties.ISO_A3)) return 0.005;
          if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 0.005;
          return 0.004;
        });
        this.textContent = 'Show Population by Country';
      }
    };

    let gdpChoroplethActive = false;
    document.getElementById('gdpChoroplethBtn').onclick = function() {
      gdpChoroplethActive = !gdpChoroplethActive;
      const gdpAlt = document.getElementById('gdpAltCheckbox').checked;
      if (gdpChoroplethActive) {
        // Find min/max GDP for scaling
        const gdps = countriesList.map(f => f.properties.GDP_MD_EST).filter(Boolean);
        const minGDP = Math.min(...gdps);
        const maxGDP = Math.max(...gdps);
        world.polygonCapColor(feat => {
          if (window.__highlightedCountry && window.__highlightedCountry === feat) return 'rgba(255, 255, 255, 0.85)';
          if (correctCountries.has(feat.properties.ISO_A3)) return 'rgba(80, 255, 80, 0.7)';
          if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 'rgba(255,0,0,0.7)';
          const gdp = feat.properties.GDP_MD_EST;
          if (!gdp || isNaN(gdp)) return gdpAlt ? 'rgba(255,255,255,1)' : 'rgba(255,255,255,0.05)';
          // Logarithmic scaling
          const norm = (Math.log(gdp) - Math.log(minGDP)) / (Math.log(maxGDP) - Math.log(minGDP));
          const r = Math.round(255 * (1 - norm) + 180 * norm);
          const g = Math.round(255 * (1 - norm) + 80 * norm);
          const b = Math.round(255 * (1 - norm));
          const alpha = gdpAlt ? 1 : (0.15 + 0.55 * norm);
          return `rgba(${r},${g},${b},${alpha.toFixed(2)})`;
        });
        if (gdpAlt) {
          world.polygonAltitude(feat => {
            if (window.__highlightedCountry && window.__highlightedCountry === feat) return 0.1;
            if (correctCountries.has(feat.properties.ISO_A3)) return 0.005;
            if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 0.005;
            const gdp = feat.properties.GDP_MD_EST;
            if (!gdp || isNaN(gdp)) return 0.004;
            // Linear scaling
            const norm = (gdp - minGDP) / (maxGDP - minGDP);
            return 0.01 + 0.09 * norm;
          });
        }
        this.textContent = 'Hide GDP by Country';
      } else {
        // Restore default coloring
        world.polygonCapColor(feat => {
          if (window.__highlightedCountry && window.__highlightedCountry === feat) return 'rgba(255, 255, 255, 0.85)';
          if (correctCountries.has(feat.properties.ISO_A3)) return 'rgba(80, 255, 80, 0.7)';
          if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 'rgba(255,0,0,0.7)';
          return 'rgba(255,255,255,.2)';
        });
        world.polygonAltitude(feat => {
          if (window.__highlightedCountry && window.__highlightedCountry === feat) return 0.1;
          if (correctCountries.has(feat.properties.ISO_A3)) return 0.005;
          if (wrongCountries && wrongCountries.has(feat.properties.ISO_A3)) return 0.005;
          return 0.004;
        });
        this.textContent = 'Show GDP by Country';
      }
    };
  </script>
</body>